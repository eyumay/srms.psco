<?php

/**
 * EnrollmentInfoTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class EnrollmentInfoTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object EnrollmentInfoTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('EnrollmentInfo');
    }
    public function enrollStudentsToSection($enrollmentIds = NULL, $sectionIds)
    {
      if($enrollmentIds == NULL)
      	return false;  	
    	foreach($enrollmentIds as $enrollmentId)
    	{
      	if(!Doctrine_Core::getTable('EnrollmentInfo')->check($enrollmentId)->count() == 1)
				return false;      	   
      	Doctrine_Core::getTable('EnrollmentInfo')
      	   ->findOneStudentEnrollmentInforById($enrollmentId)->updateEnrollmentSection($sectionIds);     	    	 
    	}
    	return true; 
    }
    public function findOneStudentEnrollmentInforById($enrollmentId = null)    
    {
      $q = Doctrine_Query::create()
        ->from('EnrollmentInfo ei__')
        ->where('ei__.id = ?', $enrollmentId); 
		return $q->fetchOne();  
    }  
    public function check($enrollmentId = null)    
    {
      $q = Doctrine_Query::create()
        ->from('EnrollmentInfo ei__')
        ->where('ei__.id = ?', $enrollmentId); 
		return $q->execute();  
    }    
    public function getOneBatchEnrollments($programId=null, $academicYear=null, $year=null, $semester=null )
    {
        $q = Doctrine_Query::create()
                ->from('EnrollmentInfo u')
                ->andWhere('u.program_id = ?', $programId)
                ->andWhere('u.academic_year = ?', $academicYear )
                ->andWhere('u.year = ?', $year)
                ->andWhere('u.semester = ?', $semester);
        
        return $q->execute();
    }
    public function getOneBatchNotRegisteredEnrollments($programId=null, $academicYear=null, $year=null, $semester=null )
    {
	     $semesterAction = 0;
        $q = Doctrine_Query::create()
                ->from('EnrollmentInfo u')
                ->andWhere('u.program_id = ?', $programId)
                ->andWhere('u.academic_year = ?', $academicYear )
                ->andWhere('u.year = ?', $year)
                ->andWhere('u.semester = ?', $semester)
                ->andWhere('u.semester_action = ?', $semesterAction);
        
        return $q->execute();        
    }    
    public function countNumberOfRegistrations($programId=null, $academicYear=null, $year=null, $semester=null )
    {
	     $semesterAction = 0;
		  // create the connection
		  $yml    = sfYaml::load(sfConfig::get('sf_config_dir').'/databases.yml');
		  $params = $yml['all']['doctrine']['param'];
		  $dbh    = new PDO($params['dsn'], $params['username'], $params['password']);
		
		  // perform your query
		  $query = "SELECT COUNT(*) FROM enrollment_info ei
		              WHERE ei.program_id		= $programId
		              AND   ei.academic_year	= $academicYear
		              AND   ei.year				= $year
		              AND   ei.semester			= $semester
		              AND   ei.semester_action	= $semesterAction
		                    INNER JOIN student_center sc
		                              WHERE    ei.student_id = sc.student_id
		   ";
		  $statement = $dbh->prepare($query);
		  $statement->execute();
		  $results = $statement->fetchAll(); 
		  return $results;  
        
    }      
    public function setSemesterActionToRegistered($enrollmentId=null )
    {    
    	Doctrine::getTable('EnrollmentInfo')->findOneById($enrollmentId)->updateEnrollmentSemesterAction(1); 	
    }
	 public function getEnrollmentDetailById($enrollmentId)
	 {
	 	return Doctrine::getTable('EnrollmentInfo')->findOneById($enrollmentId); 	 	
	 }    
}