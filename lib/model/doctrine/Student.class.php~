<?php

/**
 * Student
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Student extends BaseStudent
{

  public function __toString()
  {
  	 return $this->getName(). " " . $this->getFathersName(). " ". $this->getGrandfathersName();
  }
  
  public function save(Doctrine_Connection $conn = null )
  {
    if($this->isNew() && !$this->getStudentUid())
    {
      $id_number = substr(mt_rand(), 0, 4)."/".substr(date('Y'), 2, 4);
      $this->setStudentUid($id_number);
    } 

    parent::save($conn);
    AutoincrementTable::updateAutoincrement($this->getId(), 'Student');     
  }
	/*public function generateId()
	{
		$id_to_try = $this->get_all_possible_ids();
		
		$login_to_try = array_shift($logins_to_try);	
		while(!UserTable::check_if_id_exists($login_to_try)){
			
		}
   } */

	protected function get_all_possible_id($suffix = "")
	{	
      // Fetch one record, if there is and if this is first record: generate record; 
	   if(UserTable::isFirstStudent()) {
	     $year = substr(date('Y'), 2, 4) - 8;
        $id_number = "0001"."/".$year;
        return $id_number;	   
      }
      else {
        $id_number = substr(mt_rand(), 0, 4)."/".substr(date('Y'), 2, 4);     
      }
      return $id_number; 
   } 

    public function getAllDepartments() {
        $departments = Doctrine_Core::getTable('Department')
                ->createQuery('a')
                ->execute();

        return $departments;
    }     
    public function getFatherNameByUid($studentuid) {
        $q = Doctrine_Query::create()
                ->from('Student u')
                ->where('u.student_uid = ?', $studentuid);

        $user = $q->fetchOne();
        return $user->getFathersName();
    }

    public function getNameByUid($studentuid) {
        $q = Doctrine_Query::create()
                ->from('Student u')
                ->where('u.student_uid = ?', $studentuid);

        $user = $q->fetchOne();
        return $user->getName();
    }

    public function getGrandfatherNameByUid($studentuid) {
        $q = Doctrine_Query::create()
                ->from('Student u')
                ->where('u.student_uid = ?', $studentuid);

        $user = $q->fetchOne();
        return $user->getGrandfathersName();
    }

    public function getNameById($id) {

        $q = Doctrine_Query::create()
                ->from('Towns j')
                ->where('j.id = ?', $id);
        $town = $q->fetchOne();
        return $town->getName();
    }
    public function getProgramNameById($id) {

        $q = Doctrine_Query::create()
                ->from('Program p')
                ->where('p.id = ?', $id);
        $program = $q->fetchOne();
        return $program->getName();
    }
    public function getFilteredName($studentname) {
      $students = Doctrine_Core::getTable('Student')
          ->createQuery('a');
      $students->orWhere('a.name like ?', $studentname.'%');
      if($students != null){
        $array_of_students = $students->fetchArray();
        return $array_of_users;
      }
      else{
        return null;
      }
    }    
}
